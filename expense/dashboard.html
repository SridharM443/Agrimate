<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fcf8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #146a1c;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      background: #f1f5f1;
      color: #333;
    }
    h1 {
      font-size: 28px;
      margin: 10px 0 20px 0;
    }
    .dashboard {
      display: flex;
      gap: 20px;
    }
    .form-section {
      flex: 1;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .form-section h2 {
      margin-top: 0;
    }
    form > * { display: block; margin: 10px 0; width: 100%; }
    form input, form button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    form button {
      background: #1d7a2a;
      color: #fff;
      cursor: pointer;
    }
    .table-section {
      flex: 2;
    }
    .summary {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .card {
      flex: 1;
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background: #f6f6f6;
    }
    button.action-btn {
      margin-right: 6px;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .edit-btn {
      background: #e7f3e8;
      color: #1d7a2a;
    }
    .delete-btn {
      background: #fbeaea;
      color: #d11a2a;
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">AgriMate</div>
    <div>
      <!-- <a href="/index.html"><button class="btn">‚Üê Back to Home</button></a> -->
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <h1>Expense Dashboard</h1>

  <div class="dashboard">
    <!-- Expense Form Section -->
    <div class="form-section">
      <h2>Add / Update Expense</h2>
      <form id="expenseForm" onsubmit="return false;">
        <input type="hidden" id="expenseId">
        <input type="text" id="category" placeholder="Category" required>
        <input type="number" id="amount" placeholder="Amount" required>
        <input type="text" id="description" placeholder="Description" required>
        <input type="date" id="date" required>
        <div>
          <button type="button" id="addBtn">Add Expense</button>
          <button type="button" id="updateBtn" style="display:none">Update Expense</button>
          <button type="button" id="cancelBtn" style="display:none">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Table Section -->
    <div class="table-section">
      <div class="summary">
        <div class="card">
          <h3>Total Entries</h3>
          <p id="totalEntries">0</p>
        </div>
        <div class="card">
          <h3>Categories</h3>
          <p id="totalCategories">0</p>
        </div>
      </div>

      <h2>Recent Expenses</h2>
      <table id="expenseTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Please login first!");
      window.location.href = "login.html";
    }

    const getUrl = "https://agrimate-springboot.onrender.com/api/expenses/get";
    const addUrl = "https://agrimate-springboot.onrender.com/api/expenses/add";
    const baseUrl = "https://agrimate-springboot.onrender.com/api/expenses";

    const addBtn = document.getElementById("addBtn");
    const updateBtn = document.getElementById("updateBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    addBtn.addEventListener("click", addExpense);
    updateBtn.addEventListener("click", updateExpense);
    cancelBtn.addEventListener("click", cancelEdit);

    async function loadExpenses() {
      try {
        const res = await fetch(getUrl, {
          headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) throw new Error("Failed to fetch");
        const expenses = await res.json();
        renderTable(expenses);
        updateSummary(expenses);
      } catch (err) {
        console.error(err);
        alert("Failed to load expenses.");
      }
    }

    function updateSummary(expenses) {
      const categories = new Set(expenses.map(e => e.category));
      document.getElementById("totalEntries").textContent = expenses.length;
      document.getElementById("totalCategories").textContent = categories.size;
    }

    function renderTable(expenses) {
      const tbody = document.querySelector("#expenseTable tbody");
      tbody.innerHTML = "";
      expenses.forEach(exp => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${exp.date}</td>
          <td>${exp.category}</td>
          <td>${exp.description}</td>
          <td>$${exp.amount}</td>
          <td>
            <button class="action-btn edit-btn" onclick="startEdit(${exp.id}, '${exp.category}', ${exp.amount}, '${exp.description}', '${exp.date}')">Edit</button>
            <button class="action-btn delete-btn" onclick="deleteExpense(${exp.id})">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function startEdit(id, category, amount, description, date) {
      document.getElementById("expenseId").value = id;
      document.getElementById("category").value = category;
      document.getElementById("amount").value = amount;
      document.getElementById("description").value = description;
      document.getElementById("date").value = date;

      addBtn.style.display = "none";
      updateBtn.style.display = "inline-block";
      cancelBtn.style.display = "inline-block";
    }

    function cancelEdit() {
      document.getElementById("expenseForm").reset();
      document.getElementById("expenseId").value = "";
      addBtn.style.display = "inline-block";
      updateBtn.style.display = "none";
      cancelBtn.style.display = "none";
    }

    async function addExpense() {
      const category = document.getElementById("category").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      const description = document.getElementById("description").value.trim();
      const date = document.getElementById("date").value;

      if (!category || isNaN(amount) || !description || !date) {
        alert("Please fill all fields correctly.");
        return;
      }

      const body = { category, amount, description, date };
      const res = await fetch(addUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        alert("Error adding expense.");
        return;
      }

      alert("Expense added!");
      cancelEdit();
      loadExpenses();
    }

    async function updateExpense() {
      const id = document.getElementById("expenseId").value;
      if (!id) return alert("No expense selected.");

      const category = document.getElementById("category").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      const description = document.getElementById("description").value.trim();
      const date = document.getElementById("date").value;

      const body = { id: Number(id), category, amount, description, date };
      const res = await fetch(`${baseUrl}/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        alert("Error updating expense.");
        return;
      }

      alert("Expense updated!");
      cancelEdit();
      loadExpenses();
    }

    async function deleteExpense(id) {
      if (!confirm("Are you sure you want to delete this expense?")) return;
      const res = await fetch(`${baseUrl}/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      if (!res.ok) {
        alert("Error deleting expense.");
        return;
      }
      alert("Expense deleted!");
      loadExpenses();
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    }

    loadExpenses();
  </script>

</body>
</html>

